Agents run checks
What checks to run are configured by config file
Agent sends statuses to hub
Hub saves statuses
Hub calculates health for each check
Hub notifies email on errors

When hub receives new check from an agent it will keep tracking that (agent, check) configuration
When the hub does not receive a check within the expected timeframe it will count the (agent, check) combination as expired
When an agent changes the interval for a check, the hub accepts the new interval. (it might notify and keep in event log)

On startup an agent asks the hub when it expects new checks. If the hub expects checks that the agent doesn't recognize it will notify hub that these are deprecated.


A namespace can be set on a check to be used by the hub for categorising checks.
Checks should have a default namespace generated by their settings and some might fetch hostname of the host they are running on

for example
"net:www.test.com"  		# for a http-up check of a site
"net:www.test.com:from-vpn"  	# for a http-up check of a site from a vpn
"machine:foobar"     		# for a cpu check on a machine


# Security

The agent connects to hub using https and tofu of the certificate.

We use generated tokens for agent authentication. The hub stores sha256 of the tokens. Sha256 is enough and we dont need something more advanced like scrypt since the tokens contain a lot of entropy.


# UI

An exaple of what the overview output could look like for a few checks, the [-] stuff is if we have an interactive ui:

--
google.com
  http-up  [
    host:www.google.com | port:80 | expectedStatus:200
    lastGood: 12:34 | lastFail: 10:37
  ]
  https-up [-]

fooname
  disk-usage /     [-]
  disk-usage /var  [-]
* disk-usage /home [-]
---





"""
www.test.com
  - http-up good
  - tls     good
  from-vpn
    - http-up  fail  "Connection refused"
    - tls      fail  "Timeout"

foobar
  - cpu     good
  - mem     good
"""



ping_check:
  host: "test.com"


cert_expiry_check:
  namespace: "test.com"
  host: "test.com"
  days: 30

disk_check:
  namespace: "homeserver"
  mountpoint: "/"
  free: "30%"



namespaces: {
  test.com: [
    {
      check-type: "cert_expiry",
      check-params: {
        host: "test.com",
        day-limit: 30
      },
      interval: 300
    },
    {
      check-type: "http_up",
      check-params: {
        host: "test.com"
        port: 80
        /* allowed status codes are 2xx, 3xx */
      }
      interval: 300
    },
    {
      check-type: "http_up",
      check-params: {
        host: "test.com",
        status_code: [200],
        port: 8081,
        tls: false
      }
      interval: 300
    }
  ],
  homeserver: [
    {
      check-type: "disk_free",
      namespace: "homeserver",
      check-params: {
        mountpoint: "/",
        free-limit: "30%",
      }
      interval: 60
    }
  ]
}
